#cloud-config
package_update: true
package_upgrade: true
packages:
  - qemu-utils
  - curl
  - unzip
  - python3
  - python3-pip
runcmd:
  - echo "Starting OVA -> QCOW2 conversion" | tee /var/log/converter.log
  - pip3 install --upgrade pip ibm-cos-sdk ibm-cos-sdk-s3transfer >> /var/log/converter.log 2>&1
  - python3 - <<'PYCODE' >> /var/log/converter.log 2>&1
import ibm_boto3
from ibm_botocore.client import Config
import os, sys, subprocess

api_key = "${api_key}"
cos_service_crn = "${cos_instance_crn}"
region = "${region}"
bucket_name = "${bucket_name}"
source_url = "${source_ova_url}"
source_bucket = "${source_ova_bucket}"
source_key = "${source_ova_object_key}"
output_object_key = "${output_object_key}"

cos = ibm_boto3.client(
    "s3",
    ibm_api_key_id=api_key,
    ibm_service_instance_id=cos_service_crn,
    config=Config(signature_version="oauth"),
    region_name=region,
)

dest_path = "/tmp/source.ova"

if source_url:
    # Download via HTTP/HTTPS
    print(f"Downloading OVA from URL: {source_url}")
    import urllib.request
    urllib.request.urlretrieve(source_url, dest_path)
else:
    # Download from COS bucket/object
    if not source_bucket or not source_key:
        print("ERROR: source_bucket/source_key not provided and no source_url set.", file=sys.stderr)
        sys.exit(1)
    print(f"Downloading OVA from COS {source_bucket}/{source_key}")
    cos.download_file(Bucket=source_bucket, Key=source_key, Filename=dest_path)

print("Download completed.")
PYCODE
  - mkdir -p /mnt/ova && cd /mnt/ova && tar -xf /tmp/source.ova >> /var/log/converter.log 2>&1
  - QCOW_OUT="/tmp/${output_object_key}"
  - SRC_DISK=$(ls /mnt/ova/*.vmdk | head -n1)
  - qemu-img convert -f vmdk -O qcow2 "$${SRC_DISK}" "${QCOW_OUT}" >> /var/log/converter.log 2>&1
  - python3 - <<'PYCODE' >> /var/log/converter.log 2>&1
import ibm_boto3
from ibm_botocore.client import Config
import os

api_key = "${api_key}"
cos_service_crn = "${cos_instance_crn}"
region = "${region}"
bucket_name = "${bucket_name}"
object_key = "${output_object_key}"
file_path = f"/tmp/{object_key}"

cos = ibm_boto3.client(
    "s3",
    ibm_api_key_id=api_key,
    ibm_service_instance_id=cos_service_crn,
    config=Config(signature_version="oauth"),
    region_name=region,
)

print(f"Uploading {file_path} to {bucket_name}/{object_key} in {region}")
cos.upload_file(Filename=file_path, Bucket=bucket_name, Key=object_key)
print("Upload completed.")
PYCODE
